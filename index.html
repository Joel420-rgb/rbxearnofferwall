// App.jsx
import React, { useState, useEffect } from "react";
import { initializeApp } from "firebase/app";
import {
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  onAuthStateChanged,
  signOut,
} from "firebase/auth";

// Firebase config (your keys)
const firebaseConfig = {
  apiKey: "AIzaSyBPzy5gI_8pYNAf6MfPAhynXFUQmoIyX0Q",
  authDomain: "offerwall-a1633.firebaseapp.com",
  projectId: "offerwall-a1633",
  storageBucket: "offerwall-a1633.firebasestorage.app",
  messagingSenderId: "1028983595144",
  appId: "1:1028983595144:web:6e57a9663cb8a52cadff3d",
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

export default function App() {
  const [user, setUser] = useState(null);
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setError("");
    });
    return unsubscribe;
  }, []);

  const handleLogin = async () => {
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (e) {
      setError(e.message);
    }
  };

  const handleRegister = async () => {
    try {
      await createUserWithEmailAndPassword(auth, email, password);
    } catch (e) {
      setError(e.message);
    }
  };

  const handleLogout = async () => {
    await signOut(auth);
  };

  if (!user) {
    return (
      <div style={styles.container}>
        <h2>Login or Register</h2>
        <input
          style={styles.input}
          type="email"
          placeholder="Email"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
        />
        <input
          style={styles.input}
          type="password"
          placeholder="Password"
          value={password}
          onChange={(e) => setPassword(e.target.value)}
        />
        <button style={styles.button} onClick={handleLogin}>
          Login
        </button>
        <button style={styles.button} onClick={handleRegister}>
          Register
        </button>
        {error && <p style={{ color: "red" }}>{error}</p>}
      </div>
    );
  }

  // User logged in, show dashboard with offerwall iframe
  const uniqueUserId = user.uid;
  const userName = encodeURIComponent(user.email || "");
  const userEmail = encodeURIComponent(user.email || "");

  return (
    <div style={{ ...styles.container, backgroundColor: "#39FF14", minHeight: "100vh" }}>
      <h1>Welcome, {user.email}</h1>
      <button style={{ ...styles.button, backgroundColor: "#222" }} onClick={handleLogout}>
        Logout
      </button>
      <h2>Your CPX Offerwall</h2>
      <iframe
        title="CPX Offerwall"
        width="100%"
        height="700"
        frameBorder="0"
        src={`https://offers.cpx-research.com/index.php?app_id=27501&ext_user_id=${uniqueUserId}&secure_hash=27501&username=${userName}&email=${userEmail}&subid_1=&subid_2=`}
        style={{ borderRadius: "8px", marginTop: "20px" }}
      />
      <div style={{ marginTop: 40 }}>
        <img
          src="https://cdn-icons-png.flaticon.com/512/196/196566.png"
          alt="Robux"
          style={{ width: 100, marginRight: 20 }}
        />
        <img
          src="https://cdn-icons-png.flaticon.com/512/2331/2331836.png"
          alt="Cash"
          style={{ width: 100 }}
        />
      </div>
    </div>
  );
}

const styles = {
  container: {
    maxWidth: 480,
    margin: "auto",
    padding: 20,
    display: "flex",
    flexDirection: "column",
    alignItems: "center",
    justifyContent: "center",
    fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
  },
  input: {
    width: "100%",
    padding: 10,
    margin: "8px 0",
    borderRadius: 5,
    border: "1px solid #ccc",
    fontSize: 16,
  },
  button: {
    width: "100%",
    padding: 12,
    margin: "8px 0",
    borderRadius: 5,
    border: "none",
    backgroundColor: "#222",
    color: "white",
    fontWeight: "bold",
    cursor: "pointer",
  },
};
